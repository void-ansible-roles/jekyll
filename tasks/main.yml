---
- name: Install dependencies
  xbps:
    pkg:
      - ruby
      - ruby-devel
      - nodejs
      - base-devel
      - git
      - rsync
    state: present

- name: Install firewall rules
  template:
    src: jekyll.rules
    dest: /etc/iptables.d/jekyll.rules
    owner: root
    group: root
    mode: 0640
  notify:
    - iptables

- name: Install Jekyll
  gem:
    name: "{{ item }}"
    state: present
    user_install: no
  with_items:
    - jekyll
    - jekyll-paginate

# Replace this with include_role once that's stable
- name: Install site
  include: roles/{{ item.webserver }}/tasks/static-files.yml
  with_items: "{{ jekyll_sites }}"


- name: Install site build script
  template:
    src: jekyll_build.sh
    dest: /usr/local/sbin/jekyll-build-{{ item.site_name }}
    owner: root
    group: root
    mode: 0755
  with_items: "{{ jekyll_sites }}"

- name: Add cron job for site
  template:
    src: jekyll_build.cron
    dest: /etc/cron.d/{{ item.site_name }}
    owner: root
    group: root
    mode: 0644
  with_items: "{{ jekyll_sites }}"
